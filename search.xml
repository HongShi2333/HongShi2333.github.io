<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Deepinfra逆向思路+过程</title>
      <link href="//post/62072.html"/>
      <url>//post/62072.html</url>
      
        <content type="html"><![CDATA[<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>前几天在网上冲浪的时候发现一个网站，叫<a href="https://deepinfra.com/">Deepinfra</a>，点击去发现是一个AI的网站，有意思的是网站首页有一个对话页面，这个页面似乎是可以直接调用站内AI的，而且没有次数、内容限制。</p><p>于是我就打开F12，发了条消息打算抓一下然后有意思的就来了。<img src="https://raw.githubusercontent.com/HongShi2333/HongShi2333.github.io/refs/heads/main/images/upload/image-TLck.png"></p><p>这个comletions直接请求<a href="https://api.deepinfra.com/v1/openai/chat/completions">https://api.deepinfra.com/v1/openai/chat/completions</a> ，这个地址与OpenAI的标准格式有一些差距，而且我找了一大圈都没找到cookie或者别的用于鉴权的东西，似乎它前端没有做鉴权，我试着在python中把调用地址填好，编了一个key，居然调用成功了，还是流式的</p><p>那么事情很有意思了，其实到这一步就已经可以了，能直接去填一下模型名直接去用。但是我想要把它接入到我的API站里，那么我就要做点多余的事了。</p><p>目标：标准OpenAI格式调用，能通过&#x2F;v1&#x2F;models获取模型列表，自定义API KEY限制请求。</p><p>首先这个项目的基调已经定下了，是2api，那么我们就需要选一个合适的语言，方便部署的同时也要足够优雅，我选择了用Deno去写。</p><h4 id="开写！"><a href="#开写！" class="headerlink" title="开写！"></a>开写！</h4><p>首先要获取模型列表，我原本打算照着请求一个个去薅，但是我突然发现他们有官方的API文档，就直接进去了，里面有首页能调用的模型，就直接copy过来用了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const SUPPORTED_MODELS = [</span><br><span class="line">  &#123; id: &quot;openai/gpt-oss-120b&quot;, object: &quot;model&quot; &#125;,</span><br><span class="line">  &#123; id: &quot;moonshotai/Kimi-K2-Instruct&quot;, object: &quot;model&quot; &#125;,</span><br><span class="line">  &#123; id: &quot;zai-org/GLM-4.5&quot;, object: &quot;model&quot; &#125;,</span><br><span class="line">  &#123; id: &quot;Qwen/Qwen3-Coder-480B-A35B-Instruct-Turbo&quot;, object: &quot;model&quot; &#125;,</span><br><span class="line">  &#123; id: &quot;deepseek-ai/DeepSeek-R1-0528-Turbo&quot;, object: &quot;model&quot; &#125;,</span><br><span class="line">  &#123; id: &quot;deepseek-ai/DeepSeek-V3-0324-Turbo&quot;, object: &quot;model&quot; &#125;,</span><br><span class="line">  &#123; id: &quot;meta-llama/Llama-4-Maverick-17B-128E-Instruct-Turbo&quot;, object: &quot;model&quot; &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>模型列表搞定之后，就该整一下模型列表和completions接口了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">serve(async (req: Request) =&gt; &#123;</span><br><span class="line">  const url = new URL(req.url);</span><br><span class="line"></span><br><span class="line">  if (req.method === &quot;GET&quot; &amp;&amp; url.pathname === &quot;/v1/models&quot;) &#123;</span><br><span class="line">    return new Response(JSON.stringify(&#123;</span><br><span class="line">      object: &quot;list&quot;,</span><br><span class="line">      data: SUPPORTED_MODELS</span><br><span class="line">    &#125;), &#123;</span><br><span class="line">      status: 200,</span><br><span class="line">      headers: &#123; &quot;Content-Type&quot;: &quot;application/json&quot; &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (req.method === &quot;POST&quot; &amp;&amp; url.pathname === &quot;/v1/chat/completions&quot;) &#123;</span><br><span class="line">    const body = await req.text();</span><br><span class="line">    const headers = new Headers(req.headers);</span><br></pre></td></tr></table></figure><p>完事儿还有自定义key，不能是个东西就过来刷</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const VALID_API_KEYS = [&quot;sk-1&quot;, &quot;sk-2&quot;];</span><br><span class="line">const auth = headers.get(&quot;Authorization&quot;);</span><br><span class="line">    const key = auth?.replace(&quot;Bearer &quot;, &quot;&quot;).trim();</span><br><span class="line">    if (!key || !VALID_API_KEYS.includes(key)) &#123;</span><br><span class="line">      return new Response(&quot;Unauthorized&quot;, &#123; status: 401 &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>还有2api不可或缺的伪造请求头了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const forwardHeaders: HeadersInit = &#123;</span><br><span class="line">  &quot;Content-Type&quot;: &quot;application/json&quot;,</span><br><span class="line">  &quot;User-Agent&quot;: &quot;Mozilla/5.0&quot;,</span><br><span class="line">  &quot;Origin&quot;: &quot;https://deepinfra.com&quot;,</span><br><span class="line">  &quot;Referer&quot;: &quot;https://deepinfra.com/&quot;,</span><br><span class="line">  &quot;x-deepinfra-source&quot;: &quot;web-embed&quot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>然后简单处理一下流式响应</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">const stream = new ReadableStream(&#123;</span><br><span class="line">  async start(controller) &#123;</span><br><span class="line">    const reader = response.body?.getReader();</span><br><span class="line">    const decoder = new TextDecoder();</span><br><span class="line"></span><br><span class="line">    while (reader) &#123;</span><br><span class="line">      const &#123; done, value &#125; = await reader.read();</span><br><span class="line">      if (done) break;</span><br><span class="line">      const chunk = decoder.decode(value);</span><br><span class="line">      for (const line of chunk.split(&quot;\n&quot;)) &#123;</span><br><span class="line">        if (line.startsWith(&quot;data: &quot;)) &#123;</span><br><span class="line">          const jsonText = line.slice(6);</span><br><span class="line">          if (jsonText === &quot;[DONE]&quot;) break;</span><br><span class="line">          try &#123;</span><br><span class="line">            const parsed = JSON.parse(jsonText);</span><br><span class="line">            const delta = parsed.choices[0].delta;</span><br><span class="line">            const reasoning = delta.reasoning_content ?? delta.content ?? &quot;&quot;;</span><br><span class="line">            const output = `data: $&#123;JSON.stringify(&#123; choices: [&#123; delta: &#123; content: reasoning &#125; &#125;] &#125;)&#125;\n\n`;</span><br><span class="line">            controller.enqueue(new TextEncoder().encode(output));</span><br><span class="line">          &#125; catch (_) &#123;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    controller.enqueue(new TextEncoder().encode(&quot;data: [DONE]\n\n&quot;));</span><br><span class="line">    controller.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>好啦！大功告成！该有的都有了，不该有的也有了（bushi）</p><p>接下来就是把它推到deno上运行了</p><p>如果您需要源码，请前往下面的链接获取。</p><p><a href="https://linux.do/t/topic/915152">[抛砖引玉]deepinfra2api，我人生中第一个2api - 开发调优 &#x2F; 开发调优, Lv2 - LINUX DO</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> 逆向 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WSA，被遗忘的官方安卓虚拟机</title>
      <link href="//post/45382.html"/>
      <url>//post/45382.html</url>
      
        <content type="html"><![CDATA[<h4 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a><strong>写在前面</strong></h4><p>WSA，Windows的安卓子系统，作为Windows11宣传中的“直接打开安卓应用”的噱头。发布初期，存在很多bug与兼容问题。微软其实是有能力完善WSA的，但是被微软大刀部砍了（祖传艺能说是）。但是我个人认为，WSA还是一个非常好的安卓虚拟机。它具有较为安全，可靠。支持直接root，ADB调试，出厂自带谷歌三件套，与Windows生态的兼容性等等优点。接下来，我们来尝试在个人PC上安装WSA。</p><h4 id="安装前"><a href="#安装前" class="headerlink" title="安装前"></a><strong>安装前</strong></h4><h5 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a><strong>系统要求</strong></h5><p>若是Windows11，最低版本为21H2 Build 22000.526。</p><p>若是Windows10，最低版本为20H2 Build 10.0.19042.2604，推荐版本为22H2 Build 10.0.19045.2311，并且已经安装了编号为<a href="https://www.catalog.update.microsoft.com/Search.aspx?q=KB5014032">KB5014032</a>以及<a href="https://www.catalog.update.microsoft.com/Search.aspx?q=KB5022834">KB5022834</a>的系统补丁</p><p>其次，必须开启电脑的硬件虚拟化，否则无法运行</p><p>推荐开启的Windows服务：虚拟机平台（必须）、Windows 虚拟机监控程序平台（可选）、适用于 Linux 的 Windows 子系统（可选）、Hyper-V（可选）</p><p>注意：如果您之前安装过官方的WSA，则需要完全卸载</p><h5 id="硬件要求"><a href="#硬件要求" class="headerlink" title="硬件要求"></a><strong>硬件要求</strong></h5><p>内存最低8GB，推荐内存为16GB</p><p>确保C盘至少有10GB可用空间。</p><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a><strong>安装</strong></h4><p>前往<a href="https://github.com/A-JiuA/WSAOnWin10/releases">https://github.com/A-JiuA/WSAOnWin10/releases</a>下载您想要的版本。</p><p>注：MindTheGapps为自带谷歌应用商店，with-magisk为自带magisk，自行选择</p><p>下载到对应版本后，自行校对哈希值，校对完成后将压缩包解压，进入目录后运行Run.bat即可。</p><h4 id="设置"><a href="#设置" class="headerlink" title="设置"></a><strong>设置</strong></h4><p>*注：从这个仓库下载的所有版本均不带有系统桌面。各位请自行安装。</p><p>首先前往进阶设置，设置好所需内存与显卡。然后，<strong>开启开发者模式</strong>并且记住端口号。</p><p>由于没有系统桌面，且WSA采用虚拟磁盘，我们需要使用ADB进行文件管理、APK安装等活动。</p><p>推荐ADB工具：<a href="https://github.com/liangweihao/adb_tool">https://github.com/liangweihao/adb_tool</a></p><p>以这个工具为例，要在输入对方设备IP连接这一栏填写127.0.0.1:[端口号]</p><p>至此。一切已经结束。</p><h4 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a><strong>尾声</strong></h4><p>如后续需要更新版本，请前往WSA主设置面板，点击关闭Windows子系统Android™版。</p><p>然后彻底删除文件所在目录，重复上文你想要的版本的安装步骤即可</p><p>最后，enjoy🥰~</p>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
          <category> 项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 项目 </tag>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>抱脸部署FileCodeBox(database同步)</title>
      <link href="//post/26312.html"/>
      <url>//post/26312.html</url>
      
        <content type="html"><![CDATA[<p>项目地址：<a href="https://github.com/vastsa/FileCodeBox">https://github.com/vastsa/FileCodeBox</a></p><p>项目名称：FileCodeBox </p><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>顾名思义，这个项目能够快速、高效地跨设备、跨网络链接实现文件、字符共享，可以自行设置过期时间&#x2F;次数。文件大小限制为20MB以内。</p><p>由于抱脸容器的特殊性（定时清空数据重启），我们需要设置database同步以达到不丢失数据。</p><h4 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h4><p>1.外网访问环境</p><p>2.一个huggingface账户</p><p>3.一点耐心</p><h4 id="必要环境变量"><a href="#必要环境变量" class="headerlink" title="必要环境变量"></a>必要环境变量</h4><p>1.huggingface自带的database服务仓库名</p><p>2.huggingface授权key</p><h3 id="部署步骤"><a href="#部署步骤" class="headerlink" title="部署步骤"></a>部署步骤</h3><h4 id="创建空间"><a href="#创建空间" class="headerlink" title="创建空间"></a>创建空间</h4><p>先前往space页面，单击New Space</p><p><img src="https://raw.githubusercontent.com/HongShi2333/HongShi2333.github.io/refs/heads/main/images/upload/image.png"></p><p>在space设置页面有几个需要填的东西</p><p>Space name：空间名称，决定域名部分（分配域名：用户名-空间名.hf.space）</p><p>Selet the Space SDK：选择Docker</p><p>Space harware：空间硬件配置，如果你不想多花冤枉钱就选择默认的free配置</p><p><img src="https://raw.githubusercontent.com/HongShi2333/HongShi2333.github.io/refs/heads/main/images/upload/image-uaia.png"></p><p>其他东西不用填，直接点击下方的Create Space</p><h4 id="存储库设置"><a href="#存储库设置" class="headerlink" title="存储库设置"></a>存储库设置</h4><p>点击个人头像，选择New Dataset<img src="https://raw.githubusercontent.com/HongShi2333/HongShi2333.github.io/refs/heads/main/images/upload/image-hdqa.png"></p><p>输入数据库名称，然后点击Create Dataset</p><p><img src="https://raw.githubusercontent.com/HongShi2333/HongShi2333.github.io/refs/heads/main/images/upload/image-wzeq.png"></p><p>这里的Datasets: xxxxx&#x2F;xxxxx将会作为DATASET_ID这个变量</p><p><img src="https://raw.githubusercontent.com/HongShi2333/HongShi2333.github.io/refs/heads/main/images/upload/image-ciqw.png"></p><h4 id="获取授权Key"><a href="#获取授权Key" class="headerlink" title="获取授权Key"></a>获取授权Key</h4><p>点击个人头像，前往Access Tokens 并输入密码进入</p><p><img src="https://raw.githubusercontent.com/HongShi2333/HongShi2333.github.io/refs/heads/main/images/upload/image-tkmw.png"></p><p>单击Creat new token</p><p>权限全部勾选（如果你懒得单独调）</p><p>创建后会返还以hf-xxxx开头的秘钥，这将作为HF_TOKEN这个变量使用。</p><h4 id="空间设置"><a href="#空间设置" class="headerlink" title="空间设置"></a>空间设置</h4><p>来到文件页面，选择README.md并在下方添加（如下图所示）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app_port: 12345</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/HongShi2333/HongShi2333.github.io/refs/heads/main/images/upload/image-bsdb.png"></p><p>然后转到Files选项卡，点击Add file并选择Create a new file</p><p>文件名为sync_data.sh</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 检查环境变量</span><br><span class="line">if [ -z &quot;$HF_TOKEN&quot; ] || [ -z &quot;$DATASET_ID&quot; ]; then</span><br><span class="line">    echo &quot;Starting without backup functionality - missing HF_TOKEN or DATASET_ID&quot;</span><br><span class="line">    exec python main.py</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 登录HuggingFace (使用环境变量方式避免交互问题)</span><br><span class="line">export HUGGING_FACE_HUB_TOKEN=$HF_TOKEN</span><br><span class="line"></span><br><span class="line"># 同步函数</span><br><span class="line">sync_data() &#123;</span><br><span class="line">    while true; do</span><br><span class="line">        echo &quot;Starting sync process at $(date)&quot;</span><br><span class="line">  </span><br><span class="line">        # 创建临时压缩文件</span><br><span class="line">        cd /app</span><br><span class="line">        timestamp=$(date +%Y%m%d_%H%M%S)</span><br><span class="line">        backup_file=&quot;backup_$&#123;timestamp&#125;.tar.gz&quot;</span><br><span class="line">  </span><br><span class="line">        tar -czf &quot;/tmp/$&#123;backup_file&#125;&quot; data/</span><br><span class="line">  </span><br><span class="line">        python3 -c &quot;</span><br><span class="line">from huggingface_hub import HfApi</span><br><span class="line">import os</span><br><span class="line">def manage_backups(api, repo_id, max_files=2):</span><br><span class="line">    files = api.list_repo_files(repo_id=repo_id, repo_type=&#x27;dataset&#x27;)</span><br><span class="line">    backup_files = [f for f in files if f.startswith(&#x27;backup_&#x27;) and f.endswith(&#x27;.tar.gz&#x27;)]</span><br><span class="line">    backup_files.sort()</span><br><span class="line">  </span><br><span class="line">    if len(backup_files) &gt;= max_files:</span><br><span class="line">        files_to_delete = backup_files[:(len(backup_files) - max_files + 1)]</span><br><span class="line">        for file_to_delete in files_to_delete:</span><br><span class="line">            try:</span><br><span class="line">                api.delete_file(path_in_repo=file_to_delete, repo_id=repo_id, repo_type=&#x27;dataset&#x27;)</span><br><span class="line">                print(f&#x27;Deleted old backup: &#123;file_to_delete&#125;&#x27;)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                print(f&#x27;Error deleting &#123;file_to_delete&#125;: &#123;str(e)&#125;&#x27;)</span><br><span class="line">try:</span><br><span class="line">    api = HfApi()</span><br><span class="line">    api.upload_file(</span><br><span class="line">        path_or_fileobj=&#x27;/tmp/$&#123;backup_file&#125;&#x27;,</span><br><span class="line">        path_in_repo=&#x27;$&#123;backup_file&#125;&#x27;,</span><br><span class="line">        repo_id=&#x27;$&#123;DATASET_ID&#125;&#x27;,</span><br><span class="line">        repo_type=&#x27;dataset&#x27;</span><br><span class="line">    )</span><br><span class="line">    print(&#x27;Backup uploaded successfully&#x27;)</span><br><span class="line">  </span><br><span class="line">    manage_backups(api, &#x27;$&#123;DATASET_ID&#125;&#x27;)</span><br><span class="line">except Exception as e:</span><br><span class="line">    print(f&#x27;Backup failed: &#123;str(e)&#125;&#x27;)</span><br><span class="line">&quot;</span><br><span class="line">        # 清理临时文件</span><br><span class="line">        rm -f &quot;/tmp/$&#123;backup_file&#125;&quot;</span><br><span class="line">  </span><br><span class="line">        # 设置同步间隔</span><br><span class="line">        SYNC_INTERVAL=$&#123;SYNC_INTERVAL:-72000&#125;</span><br><span class="line">        echo &quot;Next sync in $&#123;SYNC_INTERVAL&#125; seconds...&quot;</span><br><span class="line">        sleep $SYNC_INTERVAL</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 恢复函数</span><br><span class="line">restore_latest() &#123;</span><br><span class="line">    echo &quot;Attempting to restore latest backup...&quot;</span><br><span class="line">    python3 -c &quot;</span><br><span class="line">try:</span><br><span class="line">    from huggingface_hub import HfApi</span><br><span class="line">    import os</span><br><span class="line">  </span><br><span class="line">    api = HfApi()</span><br><span class="line">    files = api.list_repo_files(&#x27;$&#123;DATASET_ID&#125;&#x27;, repo_type=&#x27;dataset&#x27;)</span><br><span class="line">    backup_files = [f for f in files if f.startswith(&#x27;backup_&#x27;) and f.endswith(&#x27;.tar.gz&#x27;)]</span><br><span class="line">  </span><br><span class="line">    if backup_files:</span><br><span class="line">        latest = sorted(backup_files)[-1]</span><br><span class="line">        api.hf_hub_download(</span><br><span class="line">            repo_id=&#x27;$&#123;DATASET_ID&#125;&#x27;,</span><br><span class="line">            filename=latest,</span><br><span class="line">            repo_type=&#x27;dataset&#x27;,</span><br><span class="line">            local_dir=&#x27;/tmp&#x27;</span><br><span class="line">        )</span><br><span class="line">        os.system(f&#x27;tar -xzf /tmp/&#123;latest&#125; -C /app&#x27;)</span><br><span class="line">        os.remove(f&#x27;/tmp/&#123;latest&#125;&#x27;)</span><br><span class="line">        print(f&#x27;Restored from &#123;latest&#125;&#x27;)</span><br><span class="line">    else:</span><br><span class="line">        print(&#x27;No backup found&#x27;)</span><br><span class="line">except Exception as e:</span><br><span class="line">    print(f&#x27;Restore failed: &#123;str(e)&#125;&#x27;)</span><br><span class="line">&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 主程序</span><br><span class="line">(</span><br><span class="line">    # 尝试恢复</span><br><span class="line">    restore_latest</span><br><span class="line">  </span><br><span class="line">    # 启动同步进程</span><br><span class="line">    sync_data &amp;</span><br><span class="line">  </span><br><span class="line">    # 启动主应用</span><br><span class="line">    exec python main.py</span><br><span class="line">) 2&gt;&amp;1 | tee -a /app/data/backup.log</span><br></pre></td></tr></table></figure><p>再次重复操作，文件名为Dockerfile</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">FROM lanol/filecodebox:beta</span><br><span class="line"></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y \</span><br><span class="line">    python3-pip \</span><br><span class="line">    git \</span><br><span class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line">RUN pip3 install --no-cache-dir huggingface_hub datasets</span><br><span class="line"></span><br><span class="line">RUN useradd -m -u 1000 user</span><br><span class="line"></span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line">ENV HOME=/home/user \</span><br><span class="line">    PATH=/home/user/.local/bin:$PATH \</span><br><span class="line">    HF_HOME=/app/data/hf_cache \</span><br><span class="line">    PYTHONUNBUFFERED=1</span><br><span class="line"></span><br><span class="line">RUN mkdir -p /app/data &amp;&amp; \</span><br><span class="line">    chown -R user:user /app/data</span><br><span class="line"></span><br><span class="line">COPY sync_data.sh /app/</span><br><span class="line">RUN chmod +x /app/sync_data.sh &amp;&amp; \</span><br><span class="line">    chown user:user /app/sync_data.sh</span><br><span class="line"></span><br><span class="line">USER user</span><br><span class="line"></span><br><span class="line">EXPOSE 12345</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;/app/sync_data.sh&quot;]</span><br></pre></td></tr></table></figure><p>然后我们转到Setting选项卡，找到Variables and secrets</p><p>单击New Secret，并将下面的值键入</p><ul><li>DATASET_ID 存储库设置 步骤中的值，为用户名&#x2F;存储库ID</li><li>HF_TOKEN 获取授权Key 步骤中的值，为hf-xxxxxxxx格式</li><li>SYNC_INTERVAL 备份间隔时间，以秒为单位，推荐3600</li></ul><p>然后我们的项目就可以顺利的跑起来了</p>]]></content>
      
      
      <categories>
          
          <category> 项目部署 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Huggingface </tag>
            
            <tag> 部署 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
